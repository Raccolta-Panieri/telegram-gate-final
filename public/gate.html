<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Accesso protetto</title>
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;height:100vh;display:flex;align-items:center;justify-content:center;background:#f3f4f6}
    .card{background:#fff;padding:20px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.08);max-width:500px;width:100%;text-align:center}
    #msg{min-height:20px;margin:12px 0;color:#333}
  </style>
</head>
<body>
  <div class="card">
    <h2>Completa il CAPTCHA per accedere</h2>
    <div id="msg">Token riutilizzabile fino alla scadenza. Inserisci il token nella query string ?t=TUO_TOKEN</div>
    <div id="widget" style="margin:18px 0"></div>
    <div id="result" style="margin-top:12px"></div>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const myToken = params.get('t');
    const msg = document.getElementById('msg');
    if (!myToken) msg.textContent = 'Token mancante nella URL. Apri il link fornito con ?t=IL_TOKEN';
    function onSuccess(tokenResponse) {
      msg.textContent = 'Verifica in corso...';
      fetch('/.netlify/functions/verify-token', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ t: myToken, 'cf-turnstile-response': tokenResponse })
      }).then(r => r.json()).then(j => {
        if (j.ok && j.url) {
          msg.textContent = 'Verifica OK, reindirizzamento...';
          window.location.href = j.url;
        } else {
          msg.textContent = 'Verifica fallita: ' + (j.detail || JSON.stringify(j));
        }
      }).catch(e => {
        msg.textContent = 'Errore rete: ' + e;
      });
    }

    window.onload = () => {
      if (window.turnstile) {
        turnstile.render('#widget', {
          sitekey: 'PUT_YOUR_TURNSTILE_SITEKEY_HERE',
          callback: onSuccess
        });
      } else {
        msg.textContent = 'Impossibile caricare il widget Turnstile';
      }
    };
  </script>
</body>
</html>
